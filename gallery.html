<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Gallery - After Patmos</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Gallery-specific styles */
        .gallery-page {
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .gallery-header {
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .gallery-logo-container {
            text-align: center;
        }

        .gallery-logo-container a {
            display: inline-block;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .gallery-logo-container a:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }

        .gallery-logo {
            max-width: 260px;
            height: auto;
            filter: invert(1);
            cursor: pointer;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .gallery-header .wallet-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .gallery-header .connect-wallet-btn {
            padding: 10px 20px;
            font-size: 13px;
        }

        .gallery-header .connect-wallet-btn.connected {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4CAF50;
        }

        /* Artwork Grid Section */
        .gallery-artwork-section {
            max-width: 1200px;
            margin: 30px auto;
        }

        .gallery-artwork-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .gallery-artwork-wrapper img {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        #gallery-nft-regions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .gallery-nft-region {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: all;
            border: 1px solid transparent;
        }

        .gallery-nft-region:hover {
            border-color: rgba(255, 255, 255, 0.5);
            z-index: 10;
        }

        .gallery-nft-region.owned {
            border-color: rgba(76, 175, 80, 0.4);
        }

        .gallery-nft-region.owned:hover {
            border-color: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .gallery-nft-region.not-owned {
            background-color: rgba(0, 0, 0, 0.85);
        }

        .gallery-nft-region.not-owned:hover {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Info Section */
        .gallery-info-section {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
        }

        .gallery-info-section h2 {
            color: #4CAF50;
            font-size: 22px;
            margin-bottom: 20px;
        }

        .gallery-info-section h3 {
            color: #fff;
            font-size: 16px;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .gallery-info-section p {
            color: #aaa;
            font-size: 14px;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .gallery-info-section ul {
            color: #aaa;
            font-size: 14px;
            line-height: 1.7;
            margin-left: 20px;
        }

        .gallery-info-section li {
            margin-bottom: 8px;
        }

        .highlight {
            color: #4CAF50;
            font-weight: 600;
        }

        /* Stats Display */
        .gallery-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Connect Prompt */
        .connect-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .connect-prompt h2 {
            color: #fff;
            margin-bottom: 15px;
        }

        .connect-prompt p {
            color: #888;
            margin-bottom: 25px;
        }

        /* NFT Detail Modal for Gallery */
        .gallery-modal-content {
            max-width: 700px;
        }

        .arweave-link {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .arweave-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
        }
    </style>
</head>
<body>
    <div class="gallery-page">
        <header class="gallery-header">
            <a href="index.html" class="back-btn" id="back-to-artwork">← Back to Artwork</a>

            <div class="gallery-logo-container">
                <a href="https://ikonberg.com/" target="_blank" rel="noopener noreferrer">
                    <img src="logowebsite.png" alt="Ikonberg" class="gallery-logo">
                </a>
            </div>

            <div class="wallet-container">
                <button id="connect-wallet-btn" class="connect-wallet-btn">Connect Wallet</button>
                <div id="wallet-menu" class="wallet-menu" style="display: none;">
                    <button id="disconnect-btn" class="wallet-menu-item">Disconnect</button>
                </div>
            </div>
        </header>

        <!-- Connect Prompt (shown when not connected) -->
        <div id="connect-prompt" class="connect-prompt">
            <h2>Connect Your Wallet</h2>
            <p>Connect your wallet to view your After Patmos NFT collection and add observations.</p>
        </div>

        <!-- Gallery Content (shown when connected) -->
        <div id="gallery-content" style="display: none;">
            <!-- Artwork Grid -->
            <div class="gallery-artwork-section">
                <div class="gallery-artwork-wrapper">
                    <img src="AfterPatmos1o1.jpg" alt="After Patmos - Complete Artwork">
                    <div id="gallery-nft-regions"></div>
                </div>
            </div>

            <!-- Info Section -->
            <div class="gallery-info-section">
                <div class="gallery-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="owned-count">0</div>
                        <div class="stat-label">NFTs Owned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="observations-count">0</div>
                        <div class="stat-label">Observations Added</div>
                    </div>
                </div>

                <h2>Your Collector Dashboard</h2>
                <p>Welcome to your personal After Patmos gallery. Here you can manage your NFTs and contribute to the collective narrative.</p>

                <h3>What You Can Do Here</h3>
                <ul>
                    <li><span class="highlight">View Your Collection:</span> The artwork above highlights the pieces you own. Your NFTs are shown in full color, while pieces you don't own are blacked out.</li>
                    <li><span class="highlight">Add Observations:</span> Click on any NFT you own to add your personal observation. This is your chance to describe what you see, feel, or interpret in your piece. Your observation will be permanently recorded.</li>
                    <li><span class="highlight">View Full Resolution:</span> Access the high-resolution Arweave link for each of your NFTs to see every detail of the artwork.</li>
                    <li><span class="highlight">View on OpenSea:</span> Quick access to your NFT's OpenSea page for trading or viewing provenance.</li>
                </ul>

                <h3>The Attestation Mechanism</h3>
                <p>As a holder of After Patmos, you are part of the <span class="highlight">Collective Conductor</span>. Your observation becomes part of the artwork's permanent metadata - a subjective account of what you perceive within your window of the masterpiece. These attestations will be used to train a bespoke AI model on the emergent, collective reality of After Patmos.</p>

                <h3>Reward for Participation</h3>
                <p>Eligible participants who contribute their observation will collectively receive <span class="highlight">50% of the proceeds</span> from the final primary sale of the 1/1 After Patmos auction.</p>
            </div>
        </div>

        <!-- NFT Detail Modal -->
        <div id="gallery-detail-modal" class="modal">
            <div class="modal-content gallery-modal-content">
                <span class="close-modal">&times;</span>
                <h2>After Patmos #<span id="gallery-token-id"></span></h2>

                <div class="nft-actions" style="margin: 20px 0;">
                    <a id="arweave-link" href="#" target="_blank" class="arweave-link">View Full Resolution on Arweave</a>
                    <a id="opensea-link" href="#" target="_blank" class="action-btn" style="margin-left: 10px;">View on OpenSea</a>
                </div>

                <div id="gallery-observation-section">
                    <div id="gallery-observation-form" class="observation-form">
                        <h3>Share Your Observation</h3>
                        <p>Describe what you see, feel, or observe in this piece. This will be permanently stored and becomes part of the collective narrative.</p>
                        <textarea id="gallery-observation-text" placeholder="What do you see, feel, or observe in this piece?" maxlength="500"></textarea>
                        <div class="char-count"><span id="gallery-char-count">0</span>/500</div>
                        <div class="form-buttons">
                            <button id="gallery-submit-observation" class="submit-btn">Submit Observation</button>
                        </div>
                        <div id="gallery-observation-status"></div>
                    </div>

                    <div id="gallery-existing-observation" class="existing-observation" style="display: none;">
                        <h3>Your Observation</h3>
                        <p id="gallery-observation-content"></p>
                        <small>Thank you for contributing to the collective narrative.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Connect Modal -->
        <div id="wallet-connect-modal" class="modal">
            <div class="modal-content wallet-connect">
                <span class="close-modal">&times;</span>
                <div id="thirdweb-connect-container"></div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" integrity="sha384-DJAx6H4M+GqPTyQ6wryKQx0zH8zH8fvmZJFLQGvq4qCEdnbLxBJVVN6PAf9X+YNg" crossorigin="anonymous"></script>
    <script src="wallet.js"></script>
    <script>
        // Gallery-specific configuration
        const NFT_CONTRACT = '0x83e2654994264333e6fdfe2e43eb862866746041';
        const TREASURY_ADDRESS = '0x764d2f2e65153a08c5509235334b08be2ae02915'.toLowerCase();
        const CLAIMER_CONTRACT = '0x83FB8FF0eAB0f036c4b3dC301483D571C5573a07'.toLowerCase();
        const OPENSEA_BASE_URL = 'https://opensea.io/assets/ethereum';

        // Grid mapping (same as main page)
        const TOKEN_TO_GRID = {};

        // Grid mapping:
        // Row 0 (top): 51-60, Row 1: 61-70, Row 2: 71-80, Row 3: 81-90, Row 4: 91-100
        // Row 5: 1-10, Row 6: 11-20, Row 7: 21-30, Row 8: 31-40, Row 9 (bottom): 41-50
        function buildGridMapping() {
            // Top half: rows 0-4 (tokens 51-100)
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 10; col++) {
                    const tokenId = 51 + (row * 10) + col;
                    TOKEN_TO_GRID[tokenId] = { row, col };
                }
            }
            // Middle section: rows 5-8 (tokens 1-40, left to right)
            for (let row = 5; row < 9; row++) {
                for (let col = 0; col < 10; col++) {
                    const tokenId = 1 + ((row - 5) * 10) + col;
                    TOKEN_TO_GRID[tokenId] = { row, col };
                }
            }
            // Bottom row: row 9 (tokens 41-50)
            for (let col = 0; col < 10; col++) {
                const tokenId = 41 + col;
                TOKEN_TO_GRID[tokenId] = { row: 9, col };
            }
        }
        buildGridMapping();

        // Gallery state
        let userOwnedTokens = [];
        let connectedAddress = null;

        // Fetch user's NFTs from the contract
        async function fetchUserNFTs(address) {
            try {
                const url = `https://eth-mainnet.g.alchemy.com/nft/v3/demo/getNFTsForOwner?owner=${address}&contractAddresses[]=${NFT_CONTRACT}&withMetadata=true&pageSize=100`;
                const response = await fetch(url);

                if (!response.ok) throw new Error('Failed to fetch NFTs');

                const data = await response.json();
                return data.ownedNfts.map(nft => ({
                    tokenId: parseInt(nft.tokenId, 10),
                    metadata: nft.raw?.metadata || {},
                    arweaveUrl: nft.raw?.metadata?.image || nft.tokenUri?.gateway || ''
                }));
            } catch (error) {
                console.error('Error fetching user NFTs:', error);
                return [];
            }
        }

        // Create the gallery grid
        function createGalleryGrid(ownedTokens) {
            const container = document.getElementById('gallery-nft-regions');
            if (!container) return;

            container.innerHTML = '';
            const ownedIds = new Set(ownedTokens.map(t => t.tokenId));

            for (let tokenId = 1; tokenId <= 100; tokenId++) {
                const gridPos = TOKEN_TO_GRID[tokenId];
                if (!gridPos) continue;

                const region = document.createElement('div');
                region.className = 'gallery-nft-region';
                region.dataset.tokenId = tokenId;

                const cellWidth = 10;
                const cellHeight = 10;

                region.style.left = `${gridPos.col * cellWidth}%`;
                region.style.top = `${gridPos.row * cellHeight}%`;
                region.style.width = `${cellWidth}%`;
                region.style.height = `${cellHeight}%`;

                const isOwned = ownedIds.has(tokenId);

                if (isOwned) {
                    region.classList.add('owned');
                    region.addEventListener('click', () => openGalleryModal(tokenId, ownedTokens.find(t => t.tokenId === tokenId)));
                } else {
                    region.classList.add('not-owned');
                }

                // Tooltip
                region.addEventListener('mouseenter', (e) => showGalleryTooltip(e, tokenId, isOwned));
                region.addEventListener('mouseleave', hideGalleryTooltip);
                region.addEventListener('mousemove', moveGalleryTooltip);

                container.appendChild(region);
            }
        }

        // Tooltip functions
        function showGalleryTooltip(e, tokenId, isOwned) {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip) return;

            const icon = isOwned ? '<span style="color: #4CAF50;">✓ Owned</span>' : '<span style="color: #666;">Not owned</span>';
            tooltip.innerHTML = `<strong>After Patmos #${tokenId}</strong><br>${icon}`;
            tooltip.classList.add('active');
            moveGalleryTooltip(e);
        }

        function moveGalleryTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip) return;
            tooltip.style.left = `${e.clientX + 15}px`;
            tooltip.style.top = `${e.clientY + 15}px`;
        }

        function hideGalleryTooltip() {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) tooltip.classList.remove('active');
        }

        // Open NFT detail modal
        function openGalleryModal(tokenId, nftData) {
            const modal = document.getElementById('gallery-detail-modal');
            const tokenIdEl = document.getElementById('gallery-token-id');
            const arweaveLink = document.getElementById('arweave-link');
            const openseaLink = document.getElementById('opensea-link');
            const observationForm = document.getElementById('gallery-observation-form');
            const existingObservation = document.getElementById('gallery-existing-observation');

            tokenIdEl.textContent = tokenId;

            // Set Arweave link from metadata
            const arweaveUrl = nftData?.arweaveUrl || nftData?.metadata?.image || '';
            if (arweaveUrl) {
                arweaveLink.href = arweaveUrl;
                arweaveLink.style.display = 'inline-block';
            } else {
                arweaveLink.style.display = 'none';
            }

            // Set OpenSea link
            openseaLink.href = `${OPENSEA_BASE_URL}/${NFT_CONTRACT}/${tokenId}`;

            // Check for existing observation
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            const existingObs = savedObservations[tokenId];

            if (existingObs) {
                observationForm.style.display = 'none';
                existingObservation.style.display = 'block';
                document.getElementById('gallery-observation-content').textContent = existingObs.text;
            } else {
                observationForm.style.display = 'block';
                existingObservation.style.display = 'none';
                document.getElementById('gallery-observation-text').value = '';
                document.getElementById('gallery-char-count').textContent = '0';
            }

            modal.dataset.tokenId = tokenId;
            modal.classList.add('active');
        }

        // Submit observation
        function submitObservation() {
            const modal = document.getElementById('gallery-detail-modal');
            const tokenId = modal.dataset.tokenId;
            const text = document.getElementById('gallery-observation-text').value.trim();
            const statusEl = document.getElementById('gallery-observation-status');

            if (!text) {
                statusEl.textContent = 'Please enter your observation';
                statusEl.className = 'error';
                statusEl.style.display = 'block';
                return;
            }

            // Save observation locally
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            savedObservations[tokenId] = {
                text: text,
                address: connectedAddress,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('gallery_observations', JSON.stringify(savedObservations));

            // Update UI
            statusEl.textContent = 'Observation saved successfully!';
            statusEl.className = 'success';
            statusEl.style.display = 'block';

            // Update observation count
            updateObservationCount();

            // Switch to showing existing observation
            setTimeout(() => {
                document.getElementById('gallery-observation-form').style.display = 'none';
                document.getElementById('gallery-existing-observation').style.display = 'block';
                document.getElementById('gallery-observation-content').textContent = text;
            }, 1500);
        }

        // Update observation count
        function updateObservationCount() {
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            const userObservations = Object.entries(savedObservations).filter(([tokenId, obs]) =>
                userOwnedTokens.some(t => t.tokenId === parseInt(tokenId))
            );
            document.getElementById('observations-count').textContent = userObservations.length;
        }

        // Initialize gallery
        async function initGallery() {
            const connectPrompt = document.getElementById('connect-prompt');
            const galleryContent = document.getElementById('gallery-content');

            // Check for connected wallet
            const savedAddress = sessionStorage.getItem('connectedWallet');

            if (!savedAddress && window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        connectedAddress = accounts[0];
                    }
                } catch (e) {
                    console.error('Error checking wallet:', e);
                }
            } else if (savedAddress) {
                connectedAddress = savedAddress;
            }

            if (connectedAddress) {
                connectPrompt.style.display = 'none';
                galleryContent.style.display = 'block';

                // Fetch user's NFTs
                console.log('Fetching NFTs for:', connectedAddress);
                const nfts = await fetchUserNFTs(connectedAddress);
                userOwnedTokens = nfts;

                console.log('User owns:', nfts.length, 'NFTs');

                // Update stats
                document.getElementById('owned-count').textContent = nfts.length;
                updateObservationCount();

                // Create grid
                createGalleryGrid(nfts);

                // Update connect button
                const connectBtn = document.getElementById('connect-wallet-btn');
                if (connectBtn) {
                    const shortAddr = `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`;
                    connectBtn.textContent = shortAddr;
                    connectBtn.classList.add('connected');
                }
            } else {
                connectPrompt.style.display = 'block';
                galleryContent.style.display = 'none';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initGallery();

            // Character count for textarea
            const textarea = document.getElementById('gallery-observation-text');
            if (textarea) {
                textarea.addEventListener('input', () => {
                    document.getElementById('gallery-char-count').textContent = textarea.value.length;
                });
            }

            // Submit observation button
            const submitBtn = document.getElementById('gallery-submit-observation');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitObservation);
            }

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
                });
            });

            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Back button - skip video
            const backBtn = document.getElementById('back-to-artwork');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    sessionStorage.setItem('afterPatmosVideoWatched', 'true');
                });
            }
        });

        // Listen for wallet connection changes
        window.addEventListener('walletConnected', (e) => {
            connectedAddress = e.detail.address;
            initGallery();
        });
    </script>
</body>
</html>
