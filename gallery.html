<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Gallery - After Patmos</title>
    
    <!-- Configuration Meta Tags (set these for production) -->
    <meta name="backend-url" content="">
    <meta name="alchemy-api-key" content="">
    
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Gallery-specific styles */
        .gallery-page {
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .gallery-header {
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .gallery-logo-container {
            text-align: center;
        }

        .gallery-logo-container a {
            display: inline-block;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .gallery-logo-container a:hover {
            transform: scale(1.05);
            opacity: 0.8;
        }

        .gallery-logo {
            max-width: 260px;
            height: auto;
            filter: invert(1);
            cursor: pointer;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .gallery-header .wallet-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .gallery-header .connect-wallet-btn {
            padding: 10px 20px;
            font-size: 13px;
        }

        .gallery-header .connect-wallet-btn.connected {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(76, 175, 80, 0.4);
            color: #4CAF50;
        }

        /* Artwork Grid Section */
        .gallery-artwork-section {
            max-width: 1200px;
            margin: 30px auto;
        }

        .gallery-artwork-wrapper {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        .gallery-artwork-wrapper img {
            display: block;
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        #gallery-nft-regions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .gallery-nft-region {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: all;
            border: 1px solid transparent;
        }

        .gallery-nft-region:hover {
            border-color: rgba(255, 255, 255, 0.5);
            z-index: 10;
        }

        .gallery-nft-region.owned {
            border-color: rgba(76, 175, 80, 0.4);
        }

        .gallery-nft-region.owned:hover {
            border-color: rgba(76, 175, 80, 0.8);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.3);
        }

        .gallery-nft-region.not-owned {
            background-color: rgba(0, 0, 0, 0.85);
        }

        .gallery-nft-region.not-owned:hover {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Info Section */
        .gallery-info-section {
            max-width: 900px;
            margin: 40px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 12px;
        }

        .gallery-info-section h2 {
            color: #4CAF50;
            font-size: 22px;
            margin-bottom: 20px;
        }

        .gallery-info-section h3 {
            color: #fff;
            font-size: 16px;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        .gallery-info-section p {
            color: #aaa;
            font-size: 14px;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .gallery-info-section ul {
            color: #aaa;
            font-size: 14px;
            line-height: 1.7;
            margin-left: 20px;
        }

        .gallery-info-section li {
            margin-bottom: 8px;
        }

        .highlight {
            color: #4CAF50;
            font-weight: 600;
        }

        /* Stats Display */
        .gallery-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Connect Prompt */
        .connect-prompt {
            text-align: center;
            padding: 60px 20px;
        }

        .connect-prompt h2 {
            color: #fff;
            margin-bottom: 15px;
        }

        .connect-prompt p {
            color: #888;
            margin-bottom: 25px;
        }

        /* NFT Detail Modal for Gallery */
        .gallery-modal-content {
            max-width: 700px;
        }

        .nft-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .arweave-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff6b00 0%, #ff9500 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .arweave-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4);
        }

        .opensea-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #2081e2 0%, #3b9eff 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .opensea-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(32, 129, 226, 0.4);
        }

        .opensea-logo {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="gallery-page">
        <header class="gallery-header">
            <a href="index.html" class="back-btn" id="back-to-artwork">← Back to Artwork</a>

            <div class="gallery-logo-container">
                <a href="https://ikonberg.com/" target="_blank" rel="noopener noreferrer">
                    <img src="logowebsite.png" alt="Ikonberg" class="gallery-logo">
                </a>
            </div>

            <div class="wallet-container">
                <button id="connect-wallet-btn" class="connect-wallet-btn">Connect Wallet</button>
                <div id="wallet-menu" class="wallet-menu" style="display: none;">
                    <button id="disconnect-btn" class="wallet-menu-item">Disconnect</button>
                </div>
            </div>
        </header>

        <!-- Connect Prompt (shown when not connected) -->
        <div id="connect-prompt" class="connect-prompt">
            <h2>Connect Your Wallet</h2>
            <p>Connect your wallet to view your After Patmos fragments and add your observations.</p>
        </div>

        <!-- Gallery Content (shown when connected) -->
        <div id="gallery-content" style="display: none;">
            <!-- Artwork Grid -->
            <div class="gallery-artwork-section">
                <div class="gallery-artwork-wrapper">
                    <img src="AfterPatmos1o1.jpg" alt="After Patmos - Complete Artwork">
                    <div id="gallery-nft-regions"></div>
                </div>
            </div>

            <!-- Info Section -->
            <div class="gallery-info-section">
                <div class="gallery-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="owned-count">0</div>
                        <div class="stat-label">NFTs Owned</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="observations-count">0</div>
                        <div class="stat-label">Observations Added</div>
                    </div>
                </div>

                <h2>Your Fragment Collection</h2>
                <p>Welcome, Observer. You have passed through <span class="highlight">The Guardian</span> and claimed your fragment of After Patmos.</p>

                <h3>Your Fragments</h3>
                <ul>
                    <li><span class="highlight">View Your Fragments:</span> The artwork above reveals the pieces you own. Your fragments are shown in full color, while unclaimed pieces remain hidden.</li>
                    <li><span class="highlight">Add Your Observation:</span> Click on any fragment you own to record your perception. Your observation becomes the <em>soul</em> of the artwork—written permanently on-chain.</li>
                    <li><span class="highlight">View Full Resolution:</span> Access the high-resolution Arweave link for each fragment.</li>
                    <li><span class="highlight">View on OpenSea:</span> Access your fragment's OpenSea page for trading or provenance.</li>
                </ul>

                <h3>The Collective Conductor</h3>
                <p>As a holder, you are one of 100 Observers who direct the future of <span class="highlight">IKONBERG</span>. Your observation is not just a password—it becomes part of the artwork's permanent metadata, a testimony of what you perceive within your window of the masterpiece.</p>

                <h3>The Final Seal</h3>
                <p>Once all 100 fragments are claimed, the 1/1 Masterwork auction begins. <span class="highlight">50% of proceeds</span> go to the 100 Observers who contributed their testimony.</p>
            </div>
        </div>

        <!-- NFT Detail Modal -->
        <div id="gallery-detail-modal" class="modal">
            <div class="modal-content gallery-modal-content">
                <span class="close-modal">&times;</span>
                <h2>After Patmos #<span id="gallery-token-id"></span></h2>

                <div class="nft-actions">
                    <a id="arweave-link" href="#" target="_blank" class="arweave-link">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                        View on Arweave
                    </a>
                    <a id="opensea-link" href="#" target="_blank" class="opensea-link">
                        <svg class="opensea-logo" viewBox="0 0 90 90" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M45 0C20.151 0 0 20.151 0 45C0 69.849 20.151 90 45 90C69.849 90 90 69.849 90 45C90 20.151 69.858 0 45 0ZM22.203 46.512L22.392 46.206L34.101 27.891C34.272 27.63 34.677 27.657 34.803 27.945C36.756 32.328 38.448 37.782 37.656 41.175C37.323 42.57 36.396 44.46 35.352 46.206C35.217 46.458 35.073 46.701 34.92 46.937C34.839 47.061 34.704 47.133 34.56 47.133H22.536C22.221 47.133 22.032 46.773 22.203 46.512ZM74.376 52.812C74.376 52.983 74.277 53.127 74.133 53.19C73.224 53.577 70.119 55.008 68.832 56.799C65.538 61.38 63.027 67.932 57.402 67.932H33.948C25.632 67.932 18.9 61.173 18.9 52.83V52.56C18.9 52.344 19.08 52.164 19.305 52.164H32.373C32.634 52.164 32.823 52.398 32.805 52.659C32.706 53.505 32.868 54.378 33.273 55.17C34.047 56.745 35.658 57.726 37.395 57.726H43.866V52.677H37.467C37.143 52.677 36.945 52.299 37.134 52.029C37.206 51.921 37.287 51.813 37.368 51.687C37.971 50.823 38.835 49.491 39.699 47.97C40.284 46.944 40.851 45.846 41.31 44.748C41.4 44.55 41.472 44.343 41.553 44.145C41.679 43.794 41.805 43.461 41.895 43.128C41.985 42.858 42.066 42.57 42.138 42.3C42.354 41.364 42.444 40.374 42.444 39.348C42.444 38.943 42.426 38.52 42.39 38.115C42.372 37.674 42.318 37.233 42.264 36.792C42.228 36.414 42.156 36.045 42.084 35.667C41.985 35.073 41.859 34.488 41.715 33.903L41.661 33.687C41.553 33.282 41.463 32.895 41.337 32.49C40.986 31.257 40.581 30.06 40.14 28.935C39.978 28.476 39.78 28.035 39.582 27.594C39.294 26.883 38.997 26.235 38.718 25.623C38.574 25.344 38.448 25.092 38.322 24.84C38.178 24.552 38.025 24.264 37.872 23.985C37.764 23.778 37.638 23.58 37.548 23.382L36.666 21.807C36.567 21.636 36.738 21.429 36.927 21.492L42.228 23.013H42.246C42.255 23.013 42.264 23.022 42.264 23.022L42.966 23.22L43.74 23.436L44.01 23.508V20.574C44.01 19.152 45.135 18 46.54 18C47.242 18 47.88 18.288 48.339 18.756C48.798 19.224 49.077 19.863 49.077 20.574V24.939L49.653 25.083C49.698 25.101 49.743 25.119 49.779 25.146C49.914 25.236 50.112 25.38 50.364 25.56C50.562 25.713 50.769 25.902 51.021 26.1C51.516 26.505 52.119 27.027 52.767 27.63C52.938 27.783 53.109 27.936 53.262 28.098C54.096 28.863 55.02 29.754 55.899 30.762C56.151 31.059 56.394 31.365 56.646 31.68C56.898 32.004 57.168 32.319 57.402 32.643C57.717 33.075 58.059 33.525 58.356 33.993C58.5 34.218 58.671 34.452 58.815 34.695C59.238 35.379 59.598 36.081 59.958 36.792C60.111 37.107 60.264 37.449 60.39 37.782C60.714 38.583 60.966 39.402 61.128 40.221C61.182 40.41 61.218 40.617 61.236 40.806V40.86C61.308 41.166 61.344 41.49 61.362 41.823C61.434 42.66 61.398 43.497 61.236 44.334C61.164 44.694 61.074 45.036 60.966 45.396C60.858 45.738 60.741 46.089 60.597 46.422C60.3 47.115 59.958 47.79 59.553 48.429C59.409 48.681 59.238 48.951 59.067 49.203C58.878 49.473 58.689 49.734 58.5 49.968C58.239 50.31 57.96 50.67 57.672 50.985C57.447 51.264 57.204 51.552 56.952 51.813C56.601 52.2 56.259 52.569 55.899 52.929C55.692 53.154 55.458 53.388 55.233 53.595C55.008 53.82 54.774 54.027 54.567 54.207C54.234 54.486 53.955 54.711 53.721 54.891L53.154 55.332C53.055 55.404 52.929 55.449 52.803 55.449H49.077V60.498H53.721C54.846 60.498 55.917 60.057 56.745 59.283C57.024 59.022 58.239 57.96 59.679 56.439C59.733 56.385 59.796 56.34 59.868 56.313L73.224 52.209C73.476 52.137 73.737 52.326 73.737 52.596L74.376 52.812Z" fill="currentColor"/>
                        </svg>
                        View on OpenSea
                    </a>
                </div>

                <div id="gallery-observation-section">
                    <div id="gallery-observation-form" class="observation-form">
                        <h3>Record Your Testimony</h3>
                        <p>What do you see? Your observation becomes the soul of your fragment—written permanently on-chain.</p>
                        <textarea id="gallery-observation-text" placeholder="I see..." maxlength="500"></textarea>
                        <div class="char-count"><span id="gallery-char-count">0</span>/500</div>
                        <div class="form-buttons">
                            <button id="gallery-submit-observation" class="submit-btn">Submit Observation</button>
                        </div>
                        <div id="gallery-observation-status"></div>
                    </div>

                    <div id="gallery-existing-observation" class="existing-observation" style="display: none;">
                        <h3>Your Testimony</h3>
                        <p id="gallery-observation-content"></p>
                        <small>Your observation is now part of After Patmos.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet Connect Modal -->
        <div id="wallet-connect-modal" class="modal">
            <div class="modal-content wallet-connect">
                <span class="close-modal">&times;</span>
                <div id="thirdweb-connect-container"></div>
            </div>
        </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js" integrity="sha384-DJAx6H4M+GqPTyQ6wryKQx0zH8zH8fvmZJFLQGvq4qCEdnbLxBJVVN6PAf9X+YNg" crossorigin="anonymous"></script>
    <script src="config.js"></script>
    <script src="wallet.js"></script>
    <script>
        // Gallery-specific configuration (uses centralized config.js)
        const CONFIG = window.AFTER_PATMOS_CONFIG || {};
        const NFT_CONTRACT = CONFIG.NFT_CONTRACT || '0x83e2654994264333e6fdfe2e43eb862866746041';
        const TREASURY_ADDRESS = (CONFIG.TREASURY_ADDRESS || '0x764d2f2e65153a08c5509235334b08be2ae02915').toLowerCase();
        const CLAIMER_CONTRACT = (CONFIG.CLAIMER_CONTRACT || '0x83FB8FF0eAB0f036c4b3dC301483D571C5573a07').toLowerCase();
        const OPENSEA_BASE_URL = CONFIG.OPENSEA_BASE_URL || 'https://opensea.io/assets/ethereum';

        // Grid mapping (same as main page)
        const TOKEN_TO_GRID = {};

        // Grid mapping:
        // Row 0 (top): 51-60, Row 1: 61-70, Row 2: 71-80, Row 3: 81-90, Row 4: 91-100
        // Row 5: 1-10, Row 6: 11-20, Row 7: 21-30, Row 8: 31-40, Row 9 (bottom): 41-50
        function buildGridMapping() {
            // Top half: rows 0-4 (tokens 51-100)
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 10; col++) {
                    const tokenId = 51 + (row * 10) + col;
                    TOKEN_TO_GRID[tokenId] = { row, col };
                }
            }
            // Middle section: rows 5-8 (tokens 1-40, left to right)
            for (let row = 5; row < 9; row++) {
                for (let col = 0; col < 10; col++) {
                    const tokenId = 1 + ((row - 5) * 10) + col;
                    TOKEN_TO_GRID[tokenId] = { row, col };
                }
            }
            // Bottom row: row 9 (tokens 41-50)
            for (let col = 0; col < 10; col++) {
                const tokenId = 41 + col;
                TOKEN_TO_GRID[tokenId] = { row: 9, col };
            }
        }
        buildGridMapping();

        // Gallery state
        let userOwnedTokens = [];
        let connectedAddress = null;

        // Fetch user's NFTs from the contract
        async function fetchUserNFTs(address) {
            try {
                const apiKey = CONFIG.ALCHEMY_API_KEY || 'demo';
                const url = `https://eth-mainnet.g.alchemy.com/nft/v3/${apiKey}/getNFTsForOwner?owner=${address}&contractAddresses[]=${NFT_CONTRACT}&withMetadata=true&pageSize=100`;
                const response = await fetch(url);

                if (!response.ok) throw new Error('Failed to fetch NFTs');

                const data = await response.json();
                return data.ownedNfts.map(nft => ({
                    tokenId: parseInt(nft.tokenId, 10),
                    metadata: nft.raw?.metadata || {},
                    arweaveUrl: nft.raw?.metadata?.image || nft.tokenUri?.gateway || ''
                }));
            } catch (error) {
                console.error('Error fetching user NFTs:', error);
                return [];
            }
        }

        // Create the gallery grid
        function createGalleryGrid(ownedTokens) {
            const container = document.getElementById('gallery-nft-regions');
            if (!container) return;

            container.innerHTML = '';
            const ownedIds = new Set(ownedTokens.map(t => t.tokenId));

            for (let tokenId = 1; tokenId <= 100; tokenId++) {
                const gridPos = TOKEN_TO_GRID[tokenId];
                if (!gridPos) continue;

                const region = document.createElement('div');
                region.className = 'gallery-nft-region';
                region.dataset.tokenId = tokenId;

                const cellWidth = 10;
                const cellHeight = 10;

                region.style.left = `${gridPos.col * cellWidth}%`;
                region.style.top = `${gridPos.row * cellHeight}%`;
                region.style.width = `${cellWidth}%`;
                region.style.height = `${cellHeight}%`;

                const isOwned = ownedIds.has(tokenId);

                if (isOwned) {
                    region.classList.add('owned');
                    region.addEventListener('click', () => openGalleryModal(tokenId, ownedTokens.find(t => t.tokenId === tokenId)));
                } else {
                    region.classList.add('not-owned');
                }

                // Tooltip
                region.addEventListener('mouseenter', (e) => showGalleryTooltip(e, tokenId, isOwned));
                region.addEventListener('mouseleave', hideGalleryTooltip);
                region.addEventListener('mousemove', moveGalleryTooltip);

                container.appendChild(region);
            }
        }

        // Tooltip functions
        function showGalleryTooltip(e, tokenId, isOwned) {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip) return;

            const icon = isOwned ? '<span style="color: #4CAF50;">✓ Owned</span>' : '<span style="color: #666;">Not owned</span>';
            tooltip.innerHTML = `<strong>After Patmos #${tokenId}</strong><br>${icon}`;
            tooltip.classList.add('active');
            moveGalleryTooltip(e);
        }

        function moveGalleryTooltip(e) {
            const tooltip = document.getElementById('tooltip');
            if (!tooltip) return;
            tooltip.style.left = `${e.clientX + 15}px`;
            tooltip.style.top = `${e.clientY + 15}px`;
        }

        function hideGalleryTooltip() {
            const tooltip = document.getElementById('tooltip');
            if (tooltip) tooltip.classList.remove('active');
        }

        // Open NFT detail modal
        function openGalleryModal(tokenId, nftData) {
            const modal = document.getElementById('gallery-detail-modal');
            const tokenIdEl = document.getElementById('gallery-token-id');
            const arweaveLink = document.getElementById('arweave-link');
            const openseaLink = document.getElementById('opensea-link');
            const observationForm = document.getElementById('gallery-observation-form');
            const existingObservation = document.getElementById('gallery-existing-observation');

            tokenIdEl.textContent = tokenId;

            // Set Arweave link from metadata
            const arweaveUrl = nftData?.arweaveUrl || nftData?.metadata?.image || '';
            if (arweaveUrl) {
                arweaveLink.href = arweaveUrl;
                arweaveLink.style.display = 'inline-block';
            } else {
                arweaveLink.style.display = 'none';
            }

            // Set OpenSea link
            openseaLink.href = `${OPENSEA_BASE_URL}/${NFT_CONTRACT}/${tokenId}`;

            // Check for existing observation
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            const existingObs = savedObservations[tokenId];

            if (existingObs) {
                observationForm.style.display = 'none';
                existingObservation.style.display = 'block';
                document.getElementById('gallery-observation-content').textContent = existingObs.text;
            } else {
                observationForm.style.display = 'block';
                existingObservation.style.display = 'none';
                document.getElementById('gallery-observation-text').value = '';
                document.getElementById('gallery-char-count').textContent = '0';
            }

            modal.dataset.tokenId = tokenId;
            modal.classList.add('active');
        }

        // Submit observation
        function submitObservation() {
            const modal = document.getElementById('gallery-detail-modal');
            const tokenId = modal.dataset.tokenId;
            const text = document.getElementById('gallery-observation-text').value.trim();
            const statusEl = document.getElementById('gallery-observation-status');

            if (!text) {
                statusEl.textContent = 'Please enter your observation';
                statusEl.className = 'error';
                statusEl.style.display = 'block';
                return;
            }

            // Save observation locally
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            savedObservations[tokenId] = {
                text: text,
                address: connectedAddress,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('gallery_observations', JSON.stringify(savedObservations));

            // Update UI
            statusEl.textContent = 'Observation saved successfully!';
            statusEl.className = 'success';
            statusEl.style.display = 'block';

            // Update observation count
            updateObservationCount();

            // Switch to showing existing observation
            setTimeout(() => {
                document.getElementById('gallery-observation-form').style.display = 'none';
                document.getElementById('gallery-existing-observation').style.display = 'block';
                document.getElementById('gallery-observation-content').textContent = text;
            }, 1500);
        }

        // Update observation count
        function updateObservationCount() {
            const savedObservations = JSON.parse(localStorage.getItem('gallery_observations') || '{}');
            const userObservations = Object.entries(savedObservations).filter(([tokenId, obs]) =>
                userOwnedTokens.some(t => t.tokenId === parseInt(tokenId))
            );
            document.getElementById('observations-count').textContent = userObservations.length;
        }

        // Initialize gallery
        async function initGallery() {
            const connectPrompt = document.getElementById('connect-prompt');
            const galleryContent = document.getElementById('gallery-content');

            // Check for connected wallet
            const savedAddress = sessionStorage.getItem('connectedWallet');

            if (!savedAddress && window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        connectedAddress = accounts[0];
                    }
                } catch (e) {
                    console.error('Error checking wallet:', e);
                }
            } else if (savedAddress) {
                connectedAddress = savedAddress;
            }

            if (connectedAddress) {
                connectPrompt.style.display = 'none';
                galleryContent.style.display = 'block';

                // Fetch user's NFTs
                console.log('Fetching NFTs for:', connectedAddress);
                const nfts = await fetchUserNFTs(connectedAddress);
                userOwnedTokens = nfts;

                console.log('User owns:', nfts.length, 'NFTs');

                // Update stats
                document.getElementById('owned-count').textContent = nfts.length;
                updateObservationCount();

                // Create grid
                createGalleryGrid(nfts);

                // Update connect button
                const connectBtn = document.getElementById('connect-wallet-btn');
                if (connectBtn) {
                    const shortAddr = `${connectedAddress.slice(0, 6)}...${connectedAddress.slice(-4)}`;
                    connectBtn.textContent = shortAddr;
                    connectBtn.classList.add('connected');
                }
            } else {
                connectPrompt.style.display = 'block';
                galleryContent.style.display = 'none';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initGallery();

            // Character count for textarea
            const textarea = document.getElementById('gallery-observation-text');
            if (textarea) {
                textarea.addEventListener('input', () => {
                    document.getElementById('gallery-char-count').textContent = textarea.value.length;
                });
            }

            // Submit observation button
            const submitBtn = document.getElementById('gallery-submit-observation');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitObservation);
            }

            // Modal close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
                });
            });

            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Back button - skip video
            const backBtn = document.getElementById('back-to-artwork');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    sessionStorage.setItem('afterPatmosVideoWatched', 'true');
                });
            }
        });

        // Listen for wallet connection changes
        window.addEventListener('walletConnected', (e) => {
            connectedAddress = e.detail.address;
            initGallery();
        });
    </script>
</body>
</html>
